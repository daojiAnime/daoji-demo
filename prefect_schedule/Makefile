.PHONY: help start stop restart logs ps clean deploy init backup

# é»˜è®¤ç›®æ ‡
help:
	@echo "Prefect Docker Compose ç®¡ç†å‘½ä»¤"
	@echo "================================"
	@echo "make start       - å¯åŠ¨æ‰€æœ‰æœåŠ¡"
	@echo "make stop        - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "make restart     - é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo "make logs        - æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—"
	@echo "make ps          - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "make init        - åˆå§‹åŒ–ç¯å¢ƒï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰"
	@echo "make deploy      - éƒ¨ç½² flow"
	@echo "make backup      - å¤‡ä»½æ•°æ®åº“"
	@echo "make clean       - æ¸…ç†æ‰€æœ‰æ•°æ®ï¼ˆå±é™©æ“ä½œï¼‰"
	@echo ""
	@echo "ç”Ÿäº§ç¯å¢ƒå‘½ä»¤:"
	@echo "make start-prod  - å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ"
	@echo "make stop-prod   - åœæ­¢ç”Ÿäº§ç¯å¢ƒ"

# åˆå§‹åŒ–ç¯å¢ƒ
init:
	@echo "ğŸ“ åˆå§‹åŒ– Prefect ç¯å¢ƒ..."
	@mkdir -p flows data backups ssl
	@if [ ! -f .env ]; then cp env.template .env; echo "âœ… .env æ–‡ä»¶å·²åˆ›å»º"; fi
	@echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

# å¯åŠ¨å¼€å‘ç¯å¢ƒ
start: init
	@echo "ğŸš€ å¯åŠ¨ Prefect æœåŠ¡..."
	@docker-compose up -d
	@echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
	@sleep 10
	@docker-compose ps
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨"
	@echo "ğŸ“– è®¿é—® UI: http://localhost:4200"

# åœæ­¢æœåŠ¡
stop:
	@echo "ğŸ›‘ åœæ­¢ Prefect æœåŠ¡..."
	@docker-compose down
	@echo "âœ… æœåŠ¡å·²åœæ­¢"

# é‡å¯æœåŠ¡
restart:
	@echo "ğŸ”„ é‡å¯ Prefect æœåŠ¡..."
	@docker-compose restart
	@echo "âœ… æœåŠ¡å·²é‡å¯"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@docker-compose logs -f

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
ps:
	@docker-compose ps

# éƒ¨ç½² flow
deploy:
	@echo "ğŸš€ éƒ¨ç½² Flow..."
	@docker-compose exec -T prefect-server sh -c "cd /flows && prefect deploy --all"
	@echo "âœ… Flow éƒ¨ç½²å®Œæˆ"

# å¤‡ä»½æ•°æ®åº“
backup:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
	@mkdir -p backups
	@docker-compose exec -T postgres pg_dump -U prefect prefect > backups/prefect_$$(date +%Y%m%d_%H%M%S).sql
	@echo "âœ… å¤‡ä»½å®Œæˆ"

# æ¸…ç†æ‰€æœ‰æ•°æ®
clean:
	@echo "âš ï¸  è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼"
	@read -p "ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ(yes/no): " confirm && [ "$$confirm" = "yes" ] || exit 1
	@docker-compose down -v
	@rm -rf data/* backups/*
	@echo "âœ… æ¸…ç†å®Œæˆ"

# ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
start-prod: init
	@echo "ğŸš€ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ..."
	@docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒå·²å¯åŠ¨"

# ç”Ÿäº§ç¯å¢ƒåœæ­¢
stop-prod:
	@echo "ğŸ›‘ åœæ­¢ç”Ÿäº§ç¯å¢ƒ..."
	@docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒå·²åœæ­¢"

# æ‰©å±• worker
scale-workers:
	@read -p "Worker æ•°é‡: " count; \
	docker-compose up -d --scale prefect-worker=$$count
	@echo "âœ… Worker å·²æ‰©å±•"

# è¿›å…¥ server å®¹å™¨
shell-server:
	@docker-compose exec prefect-server bash

# è¿›å…¥ worker å®¹å™¨
shell-worker:
	@docker-compose exec prefect-worker bash

# å¥åº·æ£€æŸ¥
health:
	@echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
	@curl -f http://localhost:4200/api/health && echo "âœ… Prefect Server å¥åº·" || echo "âŒ Prefect Server å¼‚å¸¸"
	@docker-compose exec -T postgres pg_isready -U prefect && echo "âœ… PostgreSQL å¥åº·" || echo "âŒ PostgreSQL å¼‚å¸¸"

# æŸ¥çœ‹ work pools
list-pools:
	@docker-compose exec -T prefect-server prefect work-pool ls

# æŸ¥çœ‹ deployments
list-deployments:
	@docker-compose exec -T prefect-server prefect deployment ls

# æŸ¥çœ‹ flow runs
list-runs:
	@docker-compose exec -T prefect-server prefect flow-run ls --limit 10

